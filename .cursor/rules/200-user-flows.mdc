# 사용자 흐름 및 플로우 규칙

## 사용자 여정 (User Journey)

### 1. 로그인 플로우
```
사용자 앱 접속
  ↓
로그인 상태 확인
  ↓
[미로그인] → Google 소셜 로그인 → 인증 토큰 반환
  ↓
프로필 등록 완료 여부 확인
  ↓
[미완료] → 온보딩으로 이동
[완료] → 메인 피드로 이동
```

**구현 규칙**:
- 루트 페이지(`app/page.tsx`)에서 인증 상태 및 프로필 완료 여부 체크
- 미인증 시 `(auth)/login`으로 리다이렉트
- 인증 완료 후 프로필 미완료 시 `(onboarding)/onboarding`으로 리다이렉트
- 모든 리다이렉트는 서버 사이드에서 처리

### 2. 온보딩 플로우 (3단계)

**Step 1: 기본 정보**
- 입력 항목: 이름, 성별, 소속관(동작/은평), 계열, 학년
- 필수 항목: 모두 필수
- 검증: 소속관은 enum 값만 허용

**Step 2: 연락처**
- 입력 항목: 전화번호, 카카오톡 ID
- 필수 항목: 둘 중 하나 이상 필수
- 검증: 전화번호 형식 검증 (010-XXXX-XXXX)

**Step 3: 라이프스타일**
- 입력 항목: 생활패턴(chronotype), 잠버릇, 흡연여부, 청결도(1-5), 소음민감도(1-5), 자기소개(최대 500자)
- 필수 항목: 생활패턴, 흡연여부
- 선택 항목: 나머지

**데이터 저장**:
- Step 3 완료 시 `profiles` 테이블에 프로필 저장
- 동시에 `matching_posts` 테이블에 매칭 게시글 생성
- 저장 성공 시 메인 피드로 자동 이동

**구현 규칙**:
- 각 스텝은 독립적인 페이지로 구성 (`step-1`, `step-2`, `step-3`)
- 스텝 간 데이터는 서버 사이드 세션 또는 URL 파라미터로 전달
- 마지막 스텝에서만 DB 저장 수행

### 3. 메인 피드 플로우

**초기 로드**:
1. 사용자의 소속관 조회 (`profiles.dormitory`)
2. 소속관 기반 `matching_posts` 조회 (RLS 정책 적용)
3. `is_active = TRUE`인 게시글만 필터링
4. 각 프로필에 대해 AI 매칭 요약 생성
5. 카드 형태로 피드 표시

**필터링**:
- 필터 옵션: 관(동작/은평), 성별, 계열, 학년, 흡연여부
- 필터 적용 시 서버 사이드에서 재조회
- 필터 상태는 URL 쿼리 파라미터로 관리

**탭 전환**:
- **전체 매칭**: 모든 활성 프로필
- **AI 추천**: `matchScore >= 80`인 프로필만 표시
- 탭 전환 시 클라이언트 사이드 필터링 가능 (이미 로드된 데이터 기준)

**구현 규칙**:
- 피드 데이터는 서버 컴포넌트에서 조회
- AI 요약은 서버 사이드에서 생성 (API Route 활용)
- 무한 스크롤 또는 페이지네이션 고려

### 4. 프로필 상세 플로우

**카드 클릭 시**:
1. 프로필 상세 페이지로 이동 (`feed/[id]`)
2. 해당 프로필의 상세 정보 표시
3. 라이프 패턴 상세 정보 노출

**연락처 확인**:
- **Phase 1**: 즉시 공개 (전화번호, 카카오톡 ID)
- **Phase 2**: 
  - 조회권 확인 (`daily_limits.reveals_remaining > 0`)
  - 조회권 있음 → 조회 로그 저장 → 조회권 차감 → 연락처 공개
  - 조회권 없음 → "오늘의 조회 한도를 초과했습니다" 알림

**구현 규칙**:
- 연락처 공개는 서버 사이드 API Route에서 처리
- 조회권 차감은 트랜잭션으로 처리 (원자성 보장)
- 조회 로그는 `view_logs` 테이블에 저장

### 5. 찜하기 플로우 (Phase 2)

**찜하기 클릭**:
1. `bookmarks` 테이블에 저장
2. 로컬 상태 업데이트
3. UI 피드백 (하트 아이콘 채움)

**찜한 목록 조회**:
- 마이페이지에서 찜한 프로필 목록 표시
- 찜한 날짜 기준 정렬

**구현 규칙**:
- 찜하기는 optimistic update 적용
- 실패 시 롤백 처리

### 6. 마이페이지 플로우

**표시 정보**:
- 내 프로필 정보 (프로필 카드 형태)
- 찜한 룸메이트 목록 (Phase 2)
- 연락처 공개 횟수 (N/3) (Phase 2)
- 프로필 수정 버튼
- 로그아웃 버튼

**프로필 수정**:
- 온보딩과 유사한 폼 구조
- 기존 데이터로 폼 초기화
- 수정 시 `profiles.updated_at` 자동 갱신

## 플로우 구현 원칙

1. **서버 사이드 우선**: 인증 체크, 데이터 조회는 서버 컴포넌트에서 처리
2. **에러 처리**: 각 단계에서 에러 발생 시 사용자 친화적 메시지 표시
3. **로딩 상태**: 데이터 페칭 중 스켈레톤 UI 또는 로딩 인디케이터 표시
4. **리다이렉트**: 인증/프로필 미완료 시 적절한 페이지로 리다이렉트
5. **URL 상태 관리**: 필터, 탭 상태는 URL 쿼리 파라미터로 관리 (`nuqs` 활용)
